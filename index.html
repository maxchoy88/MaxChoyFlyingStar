
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº„æ°é£æ˜Ÿç´«å¾®æ–—æ•° - ç™½è¯ææ•°å‘½ä¹¦ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --mystic-gold: #fbbf24;
            --ethereal-rose: #fb7185;
            --deep-indigo: #020617;
            --glass-border: rgba(255, 255, 255, 0.08);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--deep-indigo);
            color: #f1f5f9;
            background-image: 
                radial-gradient(circle at 50% -20%, #1e1b4b 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, #0f172a 0%, transparent 40%);
            background-attachment: fixed;
            margin: 0;
            overflow-x: hidden;
        }
        .chinese-font { font-family: 'Noto Serif SC', serif; }
        .ziwei-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
            aspect-ratio: 1 / 1;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
            50% { box-shadow: 0 0 20px 2px rgba(251, 191, 36, 0.2); }
        }
        .pulse-gold { animation: pulse-gold 3s infinite ease-in-out; }

        @media print {
            body { background: white !important; color: black !important; background-image: none !important; }
            .no-print { display: none !important; }
            #root { display: none !important; }
            .print-only { display: block !important; padding: 40px; font-family: 'Noto Serif SC', serif; line-height: 1.8; color: #000 !important; }
            .print-header { border-bottom: 3px solid #000; margin-bottom: 30px; padding-bottom: 20px; text-align: center; }
            .print-content { white-space: pre-wrap; text-align: justify; font-size: 12pt; line-height: 2.2; }
            .print-footer { margin-top: 50px; border-top: 1px solid #ddd; font-size: 10pt; text-align: center; color: #666; }
        }
        @media screen { .print-only { display: none; } }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "@google/genai": "https://esm.sh/@google/genai@1.3.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    <div id="print-mount" class="print-only"></div>

    <script type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';

        // --- Constants & Engine Logic ---
        const GANS = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"];
        const ZHIS = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];
        const PALACE_NAMES = ["å‘½å®«", "å…„å¼Ÿ", "å¤«å¦»", "å­å¥³", "è´¢å¸›", "ç–¾å„", "è¿ç§»", "äº¤å‹", "å®˜ç¦„", "ç”°å®…", "ç¦å¾·", "çˆ¶æ¯"];
        const SI_HUA_MAP = {
            "ç”²": { "ç¦„": "å»‰è´", "æƒ": "ç ´å†›", "ç§‘": "æ­¦æ›²", "å¿Œ": "å¤ªé˜³" },
            "ä¹™": { "ç¦„": "å¤©æœº", "æƒ": "å¤©æ¢", "ç§‘": "ç´«å¾®", "å¿Œ": "å¤ªé˜´" },
            "ä¸™": { "ç¦„": "å¤©åŒ", "æƒ": "å¤©æœº", "ç§‘": "æ–‡æ˜Œ", "å¿Œ": "å»‰è´" },
            "ä¸": { "ç¦„": "å¤ªé˜´", "æƒ": "å¤©åŒ", "ç§‘": "å¤©æœº", "å¿Œ": "å·¨é—¨" },
            "æˆŠ": { "ç¦„": "è´ªç‹¼", "æƒ": "å¤ªé˜´", "ç§‘": "å³å¼¼", "å¿Œ": "å¤©æœº" },
            "å·±": { "ç¦„": "æ­¦æ›²", "æƒ": "è´ªç‹¼", "ç§‘": "å¤©æ¢", "å¿Œ": "æ–‡æ›²" },
            "åºš": { "ç¦„": "å¤ªé˜³", "æƒ": "æ­¦æ›²", "ç§‘": "å¤ªé˜´", "å¿Œ": "å¤©åŒ" },
            "è¾›": { "ç¦„": "å·¨é—¨", "æƒ": "å¤ªé˜³", "ç§‘": "æ–‡æ›²", "å¿Œ": "æ–‡æ˜Œ" },
            "å£¬": { "ç¦„": "å¤©æ¢", "æƒ": "ç´«å¾®", "ç§‘": "å·¦è¾…", "å¿Œ": "æ­¦æ›²" },
            "ç™¸": { "ç¦„": "ç ´å†›", "æƒ": "å·¨é—¨", "ç§‘": "å¤ªé˜´", "å¿Œ": "è´ªç‹¼" },
        };
        const GRID_MAP = {
            11: { r: 0, c: 0 }, 0: { r: 0, c: 1 }, 1: { r: 0, c: 2 }, 2: { r: 0, c: 3 },
            10: { r: 1, c: 0 },                                        3: { r: 1, c: 3 },
            9:  { r: 2, c: 0 },                                        4: { r: 2, c: 3 },
            8:  { r: 3, c: 0 }, 7: { r: 3, c: 1 }, 6: { r: 3, c: 2 }, 5: { r: 3, c: 3 }
        };

        const getLunarDate = (y, m, d) => {
            const months = ["æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "å†¬æœˆ", "è…Šæœˆ"];
            const days = ["åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå", "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå", "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"];
            const yearGanIdx = (y - 4) % 10;
            const yearZhiIdx = (y - 4) % 12;
            const sbYear = GANS[yearGanIdx] + ZHIS[yearZhiIdx] + "å¹´";
            return { year: y, month: m, day: d, fullLunarStr: `${sbYear}${months[m-1]}${days[d-1]}` };
        };

        const calculateChart = (name, y, m, d, hourIdx) => {
            const yearGanIdx = (y - 4) % 10;
            let mingPos = (m - 1) - hourIdx + 2;
            mingPos = (mingPos % 12 + 12) % 12;
            const palaces = [];
            for (let i = 0; i < 12; i++) {
                const dist = (mingPos - i + 12) % 12;
                const pName = PALACE_NAMES[dist];
                const tigerGanIdx = (yearGanIdx * 2 + 2) % 10;
                const pGanIdx = (tigerGanIdx + (i - 2 + 12) % 12) % 10;
                palaces.push({
                    zhi_idx: i, zhi: ZHIS[i], gan: GANS[pGanIdx], name: pName,
                    stars: i === 8 ? ["å»‰è´"] : i === 2 ? ["ç ´å†›"] : i === 0 ? ["æ­¦æ›²"] : []
                });
            }
            return { name, palaces };
        };

        // --- Components ---
        const PalaceCard = ({ palace, isSelected, isTargeted, huaType, onClick }) => (
            <div onClick={onClick} className={`relative h-full w-full p-2.5 rounded-xl border transition-all cursor-pointer overflow-hidden group ${isSelected ? 'bg-indigo-500/10 border-indigo-400 ring-1 ring-indigo-400/50' : 'bg-slate-900/40 border-slate-800/80 hover:border-slate-600'}`}>
                <div className="absolute -right-2 -bottom-2 text-2xl font-black opacity-[0.05]">{palace.zhi}</div>
                <div className="flex justify-between items-start">
                    <div className="flex flex-col text-[9px] font-black text-slate-500">
                        <span>{palace.gan}</span><span>{palace.zhi}</span>
                    </div>
                    {isTargeted && <div className="bg-emerald-500 text-slate-950 font-black px-1 py-0.5 rounded text-[8px]">{huaType}</div>}
                </div>
                <div className="mt-2 flex flex-col gap-1 min-h-[30px]">
                    {palace.stars.map(s => <span key={s} className="text-[12px] font-bold text-rose-300 chinese-font">{s}</span>)}
                </div>
                <div className="absolute bottom-1 right-2 text-[13px] font-black chinese-font text-slate-400">{palace.name}</div>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [name, setName] = useState('å‘½ä¸»');
            const [gender, setGender] = useState('male');
            const [date, setDate] = useState({ y: 1994, m: 10, d: 24 });
            const [hour, setHour] = useState(0);
            const [chart, setChart] = useState(null);
            const [selected, setSelected] = useState(null);
            const [aiInfo, setAiInfo] = useState('');
            const [deepReport, setDeepReport] = useState('');
            const [loading, setLoading] = useState(false);
            const [showReport, setShowReport] = useState(false);
            const [step, setStep] = useState(0);

            useEffect(() => {
                setChart(calculateChart(name, date.y, date.m, date.d, hour));
            }, [name, date, hour]);

            const lStr = useMemo(() => getLunarDate(date.y, date.m, date.d).fullLunarStr, [date]);

            const handlePalace = async (p) => {
                setSelected(p);
                setLoading(true);
                try {
                    const ai = new GoogleGenAI({ apiKey: 'API_KEY_PLACEHOLDER' }); // process.env.API_KEY handled by environment
                    const res = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `è¯·ç”¨ç®€ç»ƒç™½è¯æ–‡è§£æç´«å¾®æ–—æ•°${p.name}å®«ï¼Œå‘½ä¸»ï¼š${name}ï¼Œç”Ÿè¾°ï¼š${lStr}ã€‚é‡ç‚¹é˜è¿°å…¶é£æ˜ŸåŒ–è±¡ã€‚100å­—ä»¥å†…ã€‚`
                    });
                    setAiInfo(res.text);
                } catch { setAiInfo('è§£ææš‚ä¸å¯ç”¨'); }
                setLoading(false);
            };

            const handleDeepReport = async () => {
                if (!selected) return;
                setLoading(true);
                setShowReport(true);
                setDeepReport('');
                setStep(0);
                const timer = setInterval(() => setStep(s => s < 3 ? s + 1 : s), 2000);
                try {
                    const ai = new GoogleGenAI({ apiKey: 'API_KEY_PLACEHOLDER' });
                    const res = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `ä½œä¸ºåº„æ°é£æ˜Ÿç´«å¾®æ–—æ•°å®—å¸ˆï¼Œè¯·ä¸ºå‘½ä¸»${name}ï¼ˆ${gender === 'male' ? 'ä¹¾é€ ' : 'å¤é€ '}ï¼Œç”Ÿè¾°${lStr}ï¼‰æ’°å†™ä¸€ä»½2500å­—çš„ã€ææ•°ç™½è¯å‘½ä¹¦ã€‘ã€‚
                        ç»“æ„åŒ…å«ï¼š1.å‘½æ ¼å¤§å±€ç™½è¯è¯¦è§£ï¼ˆ500å­—ï¼‰ï¼›2.æ€§æ ¼ä¸æ½œèƒ½æ·±åº¦å‰–æï¼ˆ400å­—ï¼‰ï¼›3.äº‹ä¸šè´¢è¿ä¸ç™½è¯é¿å‘æŒ‡å—ï¼ˆ500å­—ï¼‰ï¼›4.2025-2027ä¸‰å¹´è¿æ°”é€å¹´è¯¦è¿°ï¼ˆ800å­—ï¼‰ï¼›5.ç”Ÿæ´»ã€å¥åº·ä¸äººé™…é”¦å›Šï¼ˆ300å­—ï¼‰ã€‚
                        è¦æ±‚ï¼šå…¨ç¯‡ä½¿ç”¨ç°ä»£ç™½è¯æ–‡ï¼Œæ·±å…¥æµ…å‡ºè®²è§£é£æ˜ŸåŒ–è±¡ï¼ˆç¦„æƒç§‘å¿Œï¼‰ï¼Œç¡®ä¿æ€»å­—æ•°æ¥è¿‘2500å­—ã€‚`
                    });
                    setDeepReport(res.text);
                } catch { setDeepReport('å¤©æœºæš‚æ—¶ä¸­æ–­ï¼Œè¯·é‡è¯•ã€‚'); }
                clearInterval(timer);
                setLoading(false);
            };

            const printReport = () => {
                document.getElementById('print-mount').innerHTML = `
                    <div class="print-header"><h1>ã€ç™½è¯ææ•°å‘½ä¹¦ã€‘2500å­—æ·±åº¦è§£æ</h1><p>å‘½ä¸»ï¼š${name} | ç”Ÿè¾°ï¼š${lStr}</p></div>
                    <div class="print-content">${deepReport.replace(/\n/g, '<br>')}</div>
                    <div class="print-footer"><p>åº„æ°é£æ˜Ÿç´«å¾®æ–—æ•°ç³»ç»Ÿç”Ÿæˆ</p></div>
                `;
                window.print();
            };

            const shareWa = () => {
                const text = `ğŸ“œ *ç™½è¯ææ•°å‘½ä¹¦* ğŸ“œ\n\nå‘½ä¸»ï¼š${name}\nç”Ÿè¾°ï¼š${lStr}\n\nç²¾åæ‘˜è¦ï¼š\n${deepReport.slice(0, 500)}...\n\nğŸ”— _[æŸ¥çœ‹å®Œæ•´2500å­—è§£æåŠPDF]_`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            };

            const steps = ["ç¥é€Ÿæ¼”ç®—å‘½ç›˜...", "æ’å¸ƒé£æ˜Ÿè½¨è¿¹...", "æ’°å†™2500å­—ç™½è¯å‘½ä¹¦...", "é¢„æµ‹2025-2027å¹´è¿åŠ¿..."];

            return (
                <div className="min-h-screen p-4 lg:p-10 flex flex-col gap-6 max-w-[1400px] mx-auto no-print">
                    <header className="glass-panel p-6 rounded-[2rem] flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-3xl font-black bg-gradient-to-r from-amber-200 to-indigo-300 bg-clip-text text-transparent chinese-font">åº„æ°é£æ˜Ÿç´«å¾®æ–—æ•°</h1>
                            <p className="text-slate-500 text-[9px] font-bold tracking-widest uppercase">Plain Language Celestial Manuscript System</p>
                        </div>
                        <div className="flex gap-4 items-center">
                            <div className="flex bg-slate-900 p-1 rounded-lg">
                                <button onClick={() => setGender('male')} className={`px-4 py-1 text-[10px] font-bold rounded ${gender === 'male' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>ä¹¾é€  (ç”·)</button>
                                <button onClick={() => setGender('female')} className={`px-4 py-1 text-[10px] font-bold rounded ${gender === 'female' ? 'bg-rose-600 text-white' : 'text-slate-500'}`}>å¤é€  (å¥³)</button>
                            </div>
                            <div className="text-xs font-bold text-amber-200 bg-amber-900/20 px-3 py-1.5 rounded-lg border border-amber-800/30">å†œå†ï¼š{lStr}</div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 glass-panel p-6 rounded-[1.5rem]">
                        <input className="bg-slate-950/50 border border-white/10 rounded-lg p-2 text-sm outline-none focus:ring-1 focus:ring-amber-500" value={name} onChange={e => setName(e.target.value)} placeholder="å§“å" />
                        <input className="bg-slate-950/50 border border-white/10 rounded-lg p-2 text-sm outline-none" type="number" value={date.y} onChange={e => setDate({...date, y: parseInt(e.target.value)})} />
                        <select className="bg-slate-950/50 border border-white/10 rounded-lg p-2 text-sm outline-none" value={date.m} onChange={e => setDate({...date, m: parseInt(e.target.value)})}>
                            {Array.from({length:12}, (_,i)=>i+1).map(m=><option key={m} value={m}>{m}æœˆ</option>)}
                        </select>
                        <select className="bg-slate-950/50 border border-white/10 rounded-lg p-2 text-sm outline-none" value={hour} onChange={e => setHour(parseInt(e.target.value))}>
                            {ZHIS.map((z,i)=><option key={z} value={i}>{z}æ—¶</option>)}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start">
                        <div className="xl:col-span-8 glass-panel p-2 rounded-[2.5rem] relative shadow-2xl">
                            <div className="absolute inset-[26%] bg-slate-950/80 border border-white/5 rounded-[2rem] flex flex-col items-center justify-center text-center p-6 z-10 pulse-gold">
                                {selected ? (
                                    <>
                                        <h3 className="text-3xl font-black text-amber-300 chinese-font mb-4">{selected.name}</h3>
                                        <button onClick={handleDeepReport} className="bg-white text-black px-6 py-3 rounded-xl text-[11px] font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-transform">
                                            æé€Ÿç”Ÿæˆ2500å­—ç™½è¯å‘½ä¹¦
                                        </button>
                                    </>
                                ) : <div className="text-slate-500 text-[10px] font-bold tracking-widest animate-pulse uppercase">è¯·é€‰æ‹©å®«ä½</div>}
                            </div>
                            <div className="ziwei-grid">
                                {chart?.palaces.map((p, i) => (
                                    <div key={i} style={{ gridRow: GRID_MAP[p.zhi_idx].r + 1, gridColumn: GRID_MAP[p.zhi_idx].c + 1 }}>
                                        <PalaceCard palace={p} isSelected={selected?.zhi_idx === p.zhi_idx} onClick={() => handlePalace(p)} />
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="xl:col-span-4 flex flex-col gap-6">
                            <div className="glass-panel p-6 rounded-[2rem] min-h-[300px] flex flex-col gap-4">
                                <h4 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">å®—å¸ˆå®æ—¶è§£è¯»</h4>
                                <div className="text-sm text-slate-300 leading-relaxed italic chinese-font">
                                    {loading && !showReport ? 'å¿«é€Ÿæ¨æ¼”ä¸­...' : aiInfo || 'ç‚¹å‡»ç›˜ä¸­å®«ä½ï¼Œè·å–é£æ˜Ÿå³æ—¶è§£è¯»ã€‚'}
                                </div>
                            </div>
                        </div>
                    </div>

                    {showReport && (
                        <div className="fixed inset-0 z-50 bg-slate-950/95 flex items-center justify-center p-4 backdrop-blur-xl">
                            <div className="bg-slate-900 border border-white/10 w-full max-w-5xl max-h-[90vh] rounded-[2rem] overflow-hidden flex flex-col shadow-2xl">
                                <div className="p-8 border-b border-white/5 flex justify-between items-center bg-slate-950/50">
                                    <div>
                                        <h2 className="text-2xl font-black chinese-font text-white">{translations.zh.deepReportTitle}</h2>
                                        <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">{name} â€¢ {gender === 'male' ? 'ä¹¾é€ ' : 'å¤é€ '} â€¢ 2500å­—æé€Ÿç™½è¯æ–‡ç‰ˆ</p>
                                    </div>
                                    <button onClick={() => setShowReport(false)} className="text-slate-500 hover:text-white transition-colors">å…³é—­</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-10 custom-scrollbar bg-slate-950/20">
                                    {loading ? (
                                        <div className="flex flex-col items-center justify-center py-20 gap-8">
                                            <div className="w-16 h-16 border-4 border-amber-500/20 border-t-amber-500 rounded-full animate-spin"></div>
                                            <p className="text-xl font-bold chinese-text text-amber-200 animate-pulse">{steps[step]}</p>
                                        </div>
                                    ) : <div className="whitespace-pre-wrap text-slate-200 leading-[2.5] text-lg max-w-3xl mx-auto pb-10 chinese-font">{deepReport}</div>}
                                </div>
                                <div className="p-8 bg-slate-950/80 border-t border-white/5 flex justify-center gap-4">
                                    <button onClick={printReport} disabled={loading} className="bg-white text-black px-10 py-4 rounded-xl text-xs font-black uppercase transition-all hover:bg-slate-100 active:scale-95 shadow-lg">æ‰“å° PDF å‘½ä¹¦</button>
                                    <button onClick={shareWa} disabled={loading} className="bg-emerald-600 text-white px-10 py-4 rounded-xl text-xs font-black uppercase transition-all hover:bg-emerald-500 active:scale-95 shadow-lg">è½¬å‘ WhatsApp</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <footer className="text-center text-[10px] text-slate-600 font-bold tracking-[0.3em] uppercase mt-10">Â© 2024 Zhuang's System â€¢ æ‹¨äº‘è§æ—¥ é¡ºåŠ¿è€Œä¸º</footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
